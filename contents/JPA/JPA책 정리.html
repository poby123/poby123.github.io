<span style="font-weight: bold; font-size: large;"># 정리의 목적</span><div>개발하다가 모르는 게 있으면... 그냥 책을 보면 된다. 그러면 굳이 왜 메모를 할까?&nbsp;</div><div>나만의 언어로 정리해야 기억에도 오래 남기 때문이다.</div><div>아무튼, 정리는 간략하게. 책 내용이 10 줄이라면 1 줄로 간추리는 것을 목적으로 한다.</div><div><br></div><div><span style="font-weight: bold; font-size: large;"># 3장 영속성 관리</span></div><div><span style="font-weight: bold;">* Entity</span></div><div>&nbsp;&nbsp;<span style="text-decoration-line: underline;">Entity Manager</span>는 Entity를 저장, 수정, 삭제, 조회하는 일을 수행한다.</div><div><div>&nbsp;&nbsp;<span style="text-decoration-line: underline;">Entity Manager</span>는 <span style="text-decoration-line: underline;">Entity Manager Factory</span>로부터 얻는데, 보통 하나의 DB당 하나의 Factory를 생성한다.</div></div><div>&nbsp;&nbsp;<span style="text-decoration-line: underline;">Entity Manager Factory</span>를 생성하는 데 비용이 많이 소모되므로, 하나만 만들어서 전체에서 공유한다.</div><div><span style="background-color: rgb(252, 185, 0);">&nbsp; <span style="text-decoration-line: underline;">Entity Manager Factory</span>는 thread-safe 하지만,</span></div><div><span style="background-color: rgb(252, 185, 0);">&nbsp; <span style="text-decoration-line: underline;">Entity Manager</span>는 thread-safe 하지 않으므로, thread 간에 절대로 공유해서는 안된다.</span></div><div><br></div><div><span style="font-weight: bold;">* Persistence Context (영속성 컨텍스트)</span></div><div>&nbsp; 말이 좀 생소하지만, 결국엔 <span style="text-decoration-line: underline;">JPA가 Entity 관리를 하는 공간</span>을 의미한다.&nbsp;&nbsp;</div><div><br></div><div>&nbsp; <span style="font-weight: bold;">+&nbsp;<span style="font-style: italic;">JPA가 Entity를 어떻게 관리할까?</span></span></div><div>&nbsp; - 1차 캐시&nbsp;</div><div>&nbsp; 내부적으로 캐시가 있어서 조회할 때, 먼저 찾아보고 없으면 DB에 조회한 후 캐시에 저장한다.</div><div><br></div><div><span style="text-decoration-color: initial;">&nbsp; - 동일성 보장</span><br></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp; 조회를 하게 되면 캐시에 저장되어 있는 인스턴스를 반환하므로 동일한 인스턴스임이 보장된다.</span><br></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><br></span></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp; - 변경 감지</span><br></span></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp; 영속성 컨텍스트안에 있는 Entity의 경우, 변경을 감지해서 알아서 update 쿼리를 만들어준다.</span><br></span></span></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp;&nbsp;</span><br></span></div><div><span style="text-decoration-color: initial;">&nbsp; - 트랙잭션을 지원하는 쓰기 지연</span><br></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp; <span style="text-decoration-line: underline;">Entity Manager</span>는 커밋하기 전까지 내부 저장소에 쿼리를 저장하고 있다가, 커밋할 때 DB에 쿼리를 날린다.</span><br></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><br></span></span></div><div><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;"><span style="text-decoration-color: initial;">&nbsp; 위와 같이 JPA가 Entity를 관리하기 위해서는&nbsp;</span></span></span><span style="font-weight: 700; text-decoration-line: underline;">Entity가&nbsp;</span><span style="font-weight: bold;"><span style="text-decoration-line: underline;">영속상태</span>&nbsp;</span>이어야 한다.</div><div><br></div><div><br></div><div>&nbsp; <span style="font-weight: bold;">+&nbsp;<span style="font-style: italic;"><span style="text-decoration-line: underline;">Entity</span>는 JPA가 관리하는 정도에 따라 4가지로 나눌 수 있다.</span></span></div><div>&nbsp; &nbsp; - 비영속: JPA가 관리하지 않음. (영속성 컨텍스트 내부에 없다.)</div><div>&nbsp; &nbsp; - 영속: JPA가 관리하는 상태. (영속성 컨텍스트에 있다. <span style="text-decoration-line: underline;">조회를 하면 영속상태가 된다.</span>)</div><div>&nbsp; &nbsp; - 준영속: JPA가 관리했다가, 안 하는 상태. (영속성 컨텍스트에 있었다가 없어졌다. <span style="text-decoration-line: underline;">detach 또는 em.close</span>)</div><div>&nbsp; &nbsp; - 삭제: 삭제된 상태(em.remove)</div><div><br></div><div>&nbsp; &nbsp; <span style="background-color: rgb(255, 255, 255); text-decoration-line: underline;">public &lt;T&gt; T merge(T entity)&nbsp;</span></div><div><span style="text-decoration-color: initial;">&nbsp;&nbsp;</span>&nbsp;&nbsp;&gt; merge 함수에 Entity를 전달하면, 새로운 영속 상태의 Entity를 반환한다.<span style="background-color: rgb(0, 0, 0); color: rgb(255, 255, 255);"><br></span></div><div>&nbsp; &nbsp; &gt; 따라서 비/준 영속 상태의 Entity가 Id값으로 조회되면 찾아서 병합하고, 없으면 새로 생성해서 병합한다.</div><div>&nbsp; &nbsp; &gt; save or update의 기능을 수행한다고 할 수 있다.</div><div><br></div><div><br></div><div><span style="font-weight: bold;">&nbsp; + <span style="font-style: italic;">Flush</span></span></div><div>&nbsp; &nbsp; - Flush를 하면 일어나는 일</div><div>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;1. 변경된 Entity를 찾아서 수정 쿼리를 작성하고, 쓰기 지연 SQL 저장소에 저장한다.</div><div>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;2. 저장된 쿼리를 DB에 전송한다. (등록, 수정, 삭제, 쿼리)</div><div><br></div><div>&nbsp; &nbsp; - Flush를 하는 방법</div><div><span style="text-decoration-color: initial;">&nbsp;&nbsp;</span>&nbsp; &nbsp; &gt; em.flush()를 호출한다.<br></div><div><span style="text-decoration-color: initial;">&nbsp;&nbsp;</span>&nbsp; &nbsp; &gt; 트랜잭션을 커밋할 때 자동 호출된다.<br></div><div><span style="text-decoration-color: initial;">&nbsp;&nbsp;</span>&nbsp; &nbsp; &gt; JPQL 쿼리를 실행할 때 자동 호출된다.<br></div><div><br></div><div><br></div><div><br></div>